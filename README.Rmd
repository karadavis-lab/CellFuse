---
title: "CellFuse"
output: html_document
---

# CellFuse

**CellFuse** is an R package for multimodal single-cell and spatial proteomics data integration using deep contrastive learning and quantile normalization.

------------------------------------------------------------------------

## ðŸ”§ Python Environment Setup (Required)

Before using `CellFuse`, you must configure Python with required packages.

``` r
# Set Python path manually (optional)
library(reticulate)

Sys.setenv(RETICULATE_PYTHON = "/usr/local/Caskroom/miniforge/base/envs/r-reticulate-env/bin/python")

# Create a virtualenv (if needed)
virtualenv_create("cellfuse_env")

# Install required packages
virtualenv_install("cellfuse_env", packages = c(
  "torch", "pandas", "scikit-learn", "matplotlib", "seaborn"
))

# Point reticulate to the environment
use_virtualenv("cellfuse_env", required = TRUE)
```

``` r
## Now install package and load it ###

devtools::install("")
library(CellFuse)


### CellFuse requires data in following formate ###

# CellFuseProject/
# â”œâ”€â”€ Reference_Data/  (e.g., Reference CyTOF or CITE-seq, rows= cells, columns =markers)
# â”œâ”€â”€ Query_Data/  (e.g. Query datasets CODEX, IMC,  CITE-seq, rows= cells, columns =markers)
# â”œâ”€â”€ Predicted_Data/  (Output folder where CellFuse will save predicted labels)
# â”œâ”€â”€ Predicted_Data/Saved_model  (Folder for saving trained CellFuse models)
  
  
### create this folders #####
  
dir.create("Reference_Data", showWarnings = FALSE)
dir.create("Query_Data", showWarnings = FALSE)
dir.create("Predicted_Data", showWarnings = FALSE)
dir.create("Predicted_Data/Saved_model", showWarnings = FALSE)

## first split your reference data in 70/30 %
RefenenceData <- read.csv("Reference_Data/CyTOF.csv")

trainIndex <- createDataPartition(RefenenceData$cluster.orig, p = 0.7, list = FALSE)
train_data <- RefenenceData[trainIndex, ]
validation_data <- RefenenceData[-trainIndex, ]

# Save the datasets
setwd("Reference_Data/")
write_csv(train_data[,c(common_cols)], "CyTOF_train.csv")
write_csv(validation_data[,c(common_cols)], "CyTOF_val.csv")


# Train the CellFuse model using Reference cell types
TrainModel(dataset_name = "CyTOF",
  data_dir = "path/to/reference_data/",save_path = "path/to/save_model/",
  device = "cpu",cluster_column = "cluster.orig",lr = 0.0009,margin = 0.8,
  bs = 256,epoch = 50,k = 5,min_delta = 0.01,
  patience = 5,val_step = 5,output_dim = 8,
  dropout_prob = 0.7,activation_function = "leaky_relu",alpha = 0.01)

# Use trained CellFuse model to predict Query cell types
PredictCells(dataset_name = "CyTOF",data_dir = "path/to/reference_data/",
  test_data_dir = "path/to/query_data/",
  test_data = "CITEseq",model_dir = "path/to/save_model/Saved_model",
  device = "cpu",cluster_column = "cluster.orig",
  lr = 0.001,margin = 0.5,bs = 256,epoch = 50,
  knn_k = 5,output_dim = 8,dropout_prob = 0.5,activation_function = "leaky_relu")


# Integrate query cell types with reference cell types
corrected_data <- IntegrateData(
  ref_path="Reference_Data/CyTOF_train.csv",query_path="Query_Data/CITEseq_test.csv",
  Celltype_col="cluster.orig")
```
